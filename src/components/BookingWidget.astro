---
/**
 * BookingWidget Component
 * 
 * A flexible booking widget component that can display different event types
 * with Cal.com integration. Supports German and Turkish locales.
 */

export interface Props {
  eventType?: string;
  lang?: 'de' | 'tr';
}

const { eventType = 'erstgesprach', lang = 'de' } = Astro.props;

// Construct the Cal.com link
const calComUsername = import.meta.env.PUBLIC_CALCOM_USERNAME || 'elternherz';
const calLink = `${calComUsername}/${eventType}`;

// Loading text based on language
const loadingText = {
  de: 'Buchungssystem wird geladen...',
  tr: 'Rezervasyon sistemi yükleniyor...'
};

// Error text based on language
const errorText = {
  de: 'Buchungssystem konnte nicht geladen werden. Bitte versuchen Sie es später erneut oder kontaktieren Sie uns direkt.',
  tr: 'Rezervasyon sistemi yüklenemedi. Lütfen daha sonra tekrar deneyin veya doğrudan bizimle iletişime geçin.'
};
---

<div class="booking-widget-wrapper" data-lang={lang} data-event-type={eventType}>
  <div class="booking-widget-loading" role="status" aria-live="polite">
    <div class="spinner"></div>
    <p>{loadingText[lang]}</p>
  </div>
  
  <div 
    id={`booking-${eventType}`}
    data-cal-link={calLink}
    data-cal-namespace={eventType}
    data-cal-config={JSON.stringify({ 
      theme: 'light',
      layout: 'month_view'
    })}
    class="booking-widget-embed"
  ></div>
  
  <div class="booking-widget-error" style="display: none;" role="alert">
    <p>{errorText[lang]}</p>
  </div>
</div>

<script>
  // Cal.com embed initialization - Following https://cal.com/help/embedding/adding-embed
  (function (C, A, L) {
    let p = function (a, ar) { a.q.push(ar); };
    let d = C.document;
    C.Cal = C.Cal || function () {
      let cal = C.Cal;
      let ar = arguments;
      if (!cal.loaded) {
        cal.ns = {};
        cal.q = cal.q || [];
        d.head.appendChild(d.createElement("script")).src = A;
        cal.loaded = true;
      }
      if (ar[0] === L) {
        const api = function () { p(api, arguments); };
        const namespace = ar[1];
        api.q = api.q || [];
        typeof namespace === "string" ? (cal.ns[namespace] = api) && p(api, ar) : p(cal, ar);
        return;
      }
      p(cal, ar);
    };
  })(window, "https://app.cal.com/embed/embed.js", "init");

  Cal("init", "erstgesprach", { origin: "https://cal.com" });

  // Initialize booking widgets
  document.addEventListener('DOMContentLoaded', () => {
    const widgets = document.querySelectorAll('.booking-widget-embed');
    
    widgets.forEach((widget) => {
      const calLink = widget.getAttribute('data-cal-link');
      const namespace = widget.getAttribute('data-cal-namespace');
      const config = JSON.parse(widget.getAttribute('data-cal-config') || '{}');
      
      if (calLink && namespace) {
        try {
          // Initialize namespace
          Cal("init", namespace, { origin: "https://cal.com" });
          
          // Create inline embed
          Cal("inline", {
            elementOrSelector: `#${widget.id}`,
            calLink: calLink,
            config: config
          });
          
          Cal.ns[namespace]("inline", {
            elementOrSelector: `#${widget.id}`,
            calLink: calLink,
            config: config
          });
          
          // Hide loading spinner after initialization
          setTimeout(() => {
            const wrapper = widget.closest('.booking-widget-wrapper');
            if (wrapper) {
              const loading = wrapper.querySelector('.booking-widget-loading');
              if (loading) {
                loading.style.display = 'none';
              }
            }
          }, 1500);
        } catch (error) {
          console.error('Failed to initialize Cal.com booking widget:', error);
          
          // Show error message
          const wrapper = widget.closest('.booking-widget-wrapper');
          if (wrapper) {
            const loading = wrapper.querySelector('.booking-widget-loading');
            const errorDiv = wrapper.querySelector('.booking-widget-error');
            if (loading) loading.style.display = 'none';
            if (errorDiv) errorDiv.style.display = 'block';
          }
        }
      }
    });
  });
</script>

<style>
  .booking-widget-wrapper {
    position: relative;
    width: 100%;
    max-width: 1000px;
    margin: 2em auto;
    min-height: 600px;
    border-radius: 8px;
    overflow: hidden;
  }

  .booking-widget-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 10;
  }

  .booking-widget-loading p {
    margin-top: 1em;
    color: var(--text-secondary);
    font-family: var(--font-family-sans);
    font-size: 1.1em;
  }

  .spinner {
    border: 4px solid rgba(52, 152, 219, 0.2);
    border-left-color: #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .booking-widget-embed {
    width: 100%;
    min-height: 600px;
    position: relative;
    z-index: 5;
  }

  .booking-widget-error {
    padding: 2em;
    text-align: center;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 8px;
    color: #856404;
  }

  .booking-widget-error p {
    margin: 0;
    font-family: var(--font-family-sans);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .booking-widget-wrapper {
      min-height: 700px;
      margin: 1em 0;
    }

    .booking-widget-embed {
      min-height: 700px;
    }
  }

  @media (max-width: 480px) {
    .booking-widget-wrapper {
      min-height: 800px;
    }

    .booking-widget-embed {
      min-height: 800px;
    }
  }
</style>
