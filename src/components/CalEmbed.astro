---
/**
 * CalEmbed Component
 * 
 * Unified Cal.com embedding component supporting both inline and floating-popup types.
 * Following Cal.com embed documentation: https://cal.com/help/embedding/adding-embed
 */

export interface Props {
  calLink: string;
  type?: 'inline' | 'floating-popup';
  locale?: 'de' | 'tr';
  buttonText?: string;
  buttonColor?: string;
  buttonTextColor?: string;
  layout?: 'month_view' | 'week_view' | 'column_view';
}

const { 
  calLink, 
  type = 'inline',
  locale = 'de',
  buttonText,
  buttonColor = '#3498db',
  buttonTextColor = '#ffffff',
  layout = 'month_view'
} = Astro.props;

const namespace = calLink.replace(/\//g, '-');
const elementId = `cal-embed-${namespace}`;

// Default button text for floating popup
const defaultButtonText = {
  de: 'Termin buchen',
  tr: 'Randevu Al'
};

// Loading text
const loadingText = {
  de: 'Buchungssystem wird geladen...',
  tr: 'Rezervasyon sistemi yükleniyor...'
};

// Error text
const errorText = {
  de: 'Buchungssystem konnte nicht geladen werden. Bitte versuchen Sie es später erneut.',
  tr: 'Rezervasyon sistemi yüklenemedi. Lütfen daha sonra tekrar deneyin.'
};

const displayText = buttonText || defaultButtonText[locale];
---

{type === 'inline' && (
  <div class="cal-embed-container" data-locale={locale}>
    <div class="cal-embed-loading">
      <div class="spinner"></div>
      <p>{loadingText[locale]}</p>
    </div>
    <div 
      id={elementId}
      data-cal-link={calLink}
      data-cal-namespace={namespace}
      data-cal-config={JSON.stringify({ 
        theme: 'light',
        layout: layout
      })}
      data-embed-type="inline"
      class="cal-embed-inline"
    ></div>
  </div>
)}

{type === 'floating-popup' && (
  <div 
    data-cal-namespace={namespace}
    data-cal-link={calLink}
    data-cal-config={JSON.stringify({ 
      theme: 'light',
      layout: layout
    })}
    data-button-text={displayText}
    data-button-color={buttonColor}
    data-button-text-color={buttonTextColor}
    data-embed-type="floating-popup"
    class="cal-embed-floating"
  ></div>
)}

<script>
  // Cal.com embed initialization - Following https://cal.com/help/embedding/adding-embed
  (function (C, A, L) {
    let p = function (a, ar) { a.q.push(ar); };
    let d = C.document;
    C.Cal = C.Cal || function () {
      let cal = C.Cal;
      let ar = arguments;
      if (!cal.loaded) {
        cal.ns = {};
        cal.q = cal.q || [];
        d.head.appendChild(d.createElement("script")).src = A;
        cal.loaded = true;
      }
      if (ar[0] === L) {
        const api = function () { p(api, arguments); };
        const namespace = ar[1];
        api.q = api.q || [];
        typeof namespace === "string" ? (cal.ns[namespace] = api) && p(api, ar) : p(cal, ar);
        return;
      }
      p(cal, ar);
    };
  })(window, "https://app.cal.com/embed/embed.js", "init");

  Cal("init");

  // Initialize embeds
  document.addEventListener('DOMContentLoaded', () => {
    // Handle inline embeds
    const inlineEmbeds = document.querySelectorAll('.cal-embed-inline');
    inlineEmbeds.forEach((embed) => {
      const calLink = embed.getAttribute('data-cal-link');
      const namespace = embed.getAttribute('data-cal-namespace');
      const config = JSON.parse(embed.getAttribute('data-cal-config') || '{}');
      
      if (calLink && namespace) {
        try {
          // Create inline embed with namespace
          Cal("inline", {
            elementOrSelector: `#${embed.id}`,
            calLink: calLink,
            namespace: namespace,
            config: config
          });
          
          // Hide loading spinner
          setTimeout(() => {
            const container = embed.closest('.cal-embed-container');
            if (container) {
              const loading = container.querySelector('.cal-embed-loading');
              if (loading) {
                loading.style.display = 'none';
              }
            }
          }, 2000);
        } catch (error) {
          console.error('Failed to initialize Cal.com inline embed:', error);
          const container = embed.closest('.cal-embed-container');
          if (container) {
            const loading = container.querySelector('.cal-embed-loading');
            if (loading) {
              const locale = container.getAttribute('data-locale') || 'de';
              const errorMessage = locale === 'tr' 
                ? 'Rezervasyon sistemi yüklenemedi. Lütfen daha sonra tekrar deneyin.'
                : 'Buchungssystem konnte nicht geladen werden. Bitte versuchen Sie es später erneut.';
              loading.innerHTML = `<p style="color: var(--text-secondary);">${errorMessage}</p>`;
            }
          }
        }
      }
    });

    // Handle floating popup embeds
    const floatingEmbeds = document.querySelectorAll('.cal-embed-floating');
    floatingEmbeds.forEach((embed) => {
      const calLink = embed.getAttribute('data-cal-link');
      const namespace = embed.getAttribute('data-cal-namespace');
      const config = JSON.parse(embed.getAttribute('data-cal-config') || '{}');
      const buttonText = embed.getAttribute('data-button-text') || 'Book a call';
      const buttonColor = embed.getAttribute('data-button-color') || '#3498db';
      const buttonTextColor = embed.getAttribute('data-button-text-color') || '#ffffff';
      
      if (calLink && namespace) {
        try {
          // Create floating button with namespace
          Cal("floatingButton", {
            calLink: calLink,
            namespace: namespace,
            config: {
              ...config,
              buttonText: buttonText,
              buttonColor: buttonColor,
              buttonTextColor: buttonTextColor
            }
          });
        } catch (error) {
          console.error('Failed to initialize Cal.com floating popup:', error);
        }
      }
    });
  });
</script>

<style>
  .cal-embed-container {
    position: relative;
    width: 100%;
    max-width: 1000px;
    margin: 2em auto;
    min-height: 600px;
  }

  .cal-embed-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 1;
  }

  .cal-embed-loading p {
    margin-top: 1em;
    color: var(--text-secondary);
    font-family: var(--font-family-sans);
  }

  .spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-left-color: var(--primary-color, #3498db);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .cal-embed-inline {
    width: 100%;
    min-height: 600px;
    position: relative;
    z-index: 2;
  }

  .cal-embed-floating {
    display: none;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .cal-embed-container {
      min-height: 700px;
      margin: 1em 0;
    }

    .cal-embed-inline {
      min-height: 700px;
    }
  }

  @media (max-width: 480px) {
    .cal-embed-container {
      min-height: 800px;
    }

    .cal-embed-inline {
      min-height: 800px;
    }
  }
</style>
