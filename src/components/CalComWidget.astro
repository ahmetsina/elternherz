---
export interface Props {
  calLink: string;
  locale?: 'de' | 'tr';
}

const { calLink, locale = 'de' } = Astro.props;
---

<div class="cal-widget-container" data-locale={locale}>
  <div class="cal-widget-loading">
    <div class="spinner"></div>
    <p>{locale === 'de' ? 'Buchungssystem wird geladen...' : 'Rezervasyon sistemi y체kleniyor...'}</p>
  </div>
  <div 
    id={`cal-${calLink.replace(/\//g, '-')}`}
    data-cal-link={calLink}
    data-cal-namespace={calLink.replace(/\//g, '-')}
    data-cal-config={JSON.stringify({ theme: 'light' })}
    class="cal-widget"
  ></div>
</div>

<script>
  // Cal.com embed script
  (function (C, A, L) {
    let p = function (a, ar) { a.q.push(ar); };
    let d = C.document;
    C.Cal = C.Cal || function () {
      let cal = C.Cal;
      let ar = arguments;
      if (!cal.loaded) {
        cal.ns = {};
        cal.q = cal.q || [];
        d.head.appendChild(d.createElement("script")).src = A;
        cal.loaded = true;
      }
      if (ar[0] === L) {
        const api = function () { p(api, arguments); };
        const namespace = ar[1];
        api.q = api.q || [];
        typeof namespace === "string" ? (cal.ns[namespace] = api) && p(api, ar) : p(cal, ar);
        return;
      }
      p(cal, ar);
    };
  })(window, "https://app.cal.com/embed/embed.js", "init");

  Cal("init", { origin: "https://cal.com" });

  // Initialize all Cal widgets on the page
  document.addEventListener('DOMContentLoaded', () => {
    const widgets = document.querySelectorAll('.cal-widget');
    widgets.forEach((widget) => {
      const calLink = widget.getAttribute('data-cal-link');
      const namespace = widget.getAttribute('data-cal-namespace');
      const config = JSON.parse(widget.getAttribute('data-cal-config') || '{}');
      
      if (calLink && namespace) {
        try {
          Cal("inline", {
            elementOrSelector: `#${widget.id}`,
            calLink: calLink,
            namespace: namespace,
            config: config
          });
          
          // Hide loading spinner after a short delay
          setTimeout(() => {
            const container = widget.closest('.cal-widget-container');
            if (container) {
              const loading = container.querySelector('.cal-widget-loading');
              if (loading) {
                loading.style.display = 'none';
              }
            }
          }, 1500);
        } catch (error) {
          console.error('Failed to initialize Cal.com widget:', error);
          const container = widget.closest('.cal-widget-container');
          if (container) {
            const loading = container.querySelector('.cal-widget-loading');
            if (loading) {
              const locale = widget.closest('[data-locale]')?.getAttribute('data-locale') || 'de';
              const errorMessage = locale === 'tr' 
                ? 'Rezervasyon sistemi y체klenemedi. L체tfen daha sonra tekrar deneyin.'
                : 'Buchungssystem konnte nicht geladen werden. Bitte versuchen Sie es sp채ter erneut.';
              loading.innerHTML = `<p style="color: var(--text-secondary);">${errorMessage}</p>`;
            }
          }
        }
      }
    });
  });
</script>

<style>
  .cal-widget-container {
    position: relative;
    width: 100%;
    max-width: 1000px;
    margin: 2em auto;
    min-height: 600px;
  }

  .cal-widget-loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    text-align: center;
    z-index: 1;
  }

  .cal-widget-loading p {
    margin-top: 1em;
    color: var(--text-secondary);
    font-family: var(--font-family-sans);
  }

  .spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-left-color: var(--primary-color);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .cal-widget {
    width: 100%;
    min-height: 600px;
    position: relative;
    z-index: 2;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .cal-widget-container {
      min-height: 700px;
      margin: 1em 0;
    }

    .cal-widget {
      min-height: 700px;
    }
  }

  @media (max-width: 480px) {
    .cal-widget-container {
      min-height: 800px;
    }

    .cal-widget {
      min-height: 800px;
    }
  }
</style>
